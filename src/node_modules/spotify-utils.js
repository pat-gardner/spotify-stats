import Spotify from 'spotify-web-api-node'

export const requiredScopes = ['user-read-playback-state']

export const spotifyFactory = async (credentials) => {
    const { accessToken, refreshToken, expires } = credentials

    const spotify = simpleSpotifyFactory()
    
    spotify.setAccessToken(accessToken)
    spotify.setRefreshToken(refreshToken)

    // If the access token has expired, refresh it
    if (expires && new Date().getTime() >= expires) {
        const data = await spotify.refreshAccessToken()
        spotify.setAccessToken(data.body.access_token)
        credentials.accessToken = data.body.access_token
    }

    return spotify
}

export const simpleSpotifyFactory = ({accessToken , refreshToken} = {}) => new Spotify({
    clientId: process.env.CLIENT_ID,
    clientSecret: process.env.CLIENT_SECRET,
    redirectUri: process.env.REDIRECT_URL,
    accessToken,
    refreshToken
}) 